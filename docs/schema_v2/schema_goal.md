# Goal and Not Goal of the schema

### 1. Goal (このスキームの目的)

最も重要な目的は、**「プロバイダーごとの構造的差異（癖）を完全に抽象化し、統一された時系列データとして扱えるようにすること」** です。

* **プロバイダー差異の完全な吸収 (Normalization)**
    * Gemini の「一括レコード（ネスト構造）」を展開（Unfold）し、時系列イベントに直す。
    * Codex の「非同期トークン通知」や「エコー（重複通知）」を整理し、生成イベントと同期させる。
    * Claude の「内包型Usage」を抽出し、独立させる。
    * これらにより、**「どのプロバイダーを使っても、DB上では同じデータ構造に見える」** 状態を作る。

* **正確なコストとパフォーマンスの可視化 (Observability)**
    * **Token:** 「サイドカー（葉ノード）」パターンと「増分検知」により、非同期ストリームであっても**過不足なく正確な課金情報**を記録する。
    * **Latency:** 「リクエスト発行完了($T_{req}$)」から「結果取得($T_{res}$)」までの差分を定義し、ユーザー視点での**ターンアラウンドタイム**を算出可能にする。

* **コンテキスト（会話履歴）の完全な再現 (Replayability)**
    * `parent_id` による「数珠つなぎ（Chain）」構造を採用することで、パラレル実行や複雑な思考ステップがあっても、**LLMに投げるべき「直列の会話履歴」を迷いなく復元できる**ようにする。

* **論理と時系列の分離 (Separation of Logic & Time)**
    * 「時系列の繋がり（`parent_id`）」と「論理的な親子関係（`tool_call_id`）」を別フィールドで管理し、**「会話の再生」と「リクエスト/レスポンスの紐付け」の両立**を実現する。

---

### 2. Not Goal (このスキームが目指さないこと・妥協点)

実データの制約上、以下の点はスコープ外とするか、意図的な近似値（仕様）として定義しました。

* **OSレベルの「厳密な実行開始時刻」の特定**
    * ログには「LLMが命令を出した時刻」と「結果が戻った時刻」しかなく、「システムがコマンドを実行し始めた瞬間」のタイムスタンプはありません。
    * **仕様:** 「命令発行時刻 ≒ 実行開始時刻」とみなし、この微差は許容する（Latencyにはキュー待ち時間などが含まれることを許容する）。

* **複雑な「分岐（Branch / Tree）」構造の保持**
    * パラレルツールコール（同時実行）などを「分岐」として表現すると、コンテキスト復元時に順序が不明確になります。
    * **仕様:** 全てを「一直線のリスト（Linked List）」として表現し、並列実行も**便宜上の順番（時系列順または配列順）で直列化**して保存する。

* **トークン情報の「完全なリアルタイム同期」**
    * Codex のようにトークン情報が遅れて届く場合、イベント発生と同時に確定させることは不可能です。
    * **仕様:** 「サイドカーイベント」として独立させ、**「遅れて届いても良いが、最終的な整合性は必ず合う」** 設計にする（イベント本体のUPDATEを避ける）。

* **Gemini のトークン内訳の推測**
    * Gemini はターン合計のトークンしか返しません。
    * **仕様:** 無理に思考ステップごとに案分せず、**「そのターンの最後の生成イベント」に合計値を紐付ける** ことで、データの嘘（推測による誤り）を防ぐ。
